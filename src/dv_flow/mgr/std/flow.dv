
# yaml-language-server: $schema=https://dv-flow.github.io/flow.dv.schema.json

#****************************************************************************
#* flow.dv
#*
#* Copyright 2023-2025 Matthew Ballance and Contributors
#*
#* Licensed under the Apache License, Version 2.0 (the "License"); you may 
#* not use this file except in compliance with the License.  
#* You may obtain a copy of the License at:
#*  
#*   http://www.apache.org/licenses/LICENSE-2.0
#*  
#* Unless required by applicable law or agreed to in writing, software 
#* distributed under the License is distributed on an "AS IS" BASIS, 
#* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  
#* See the License for the specific language governing permissions and 
#* limitations under the License.
#*
#* Created on:
#*     Author: 
#*
#****************************************************************************

package:
  name: std
  desc: Standard library providing core tasks, types, and utilities for DV Flow workflows

  tasks:
  - name: Message
    shell: pytask
    run: dv_flow.mgr.std.message.Message
    with:
      msg:
        type: str
        value: ""
  - name: FileSet
    doc: |
      Creates a fileset from a list of files or glob patterns
    shell: pytask
    run: dv_flow.mgr.std.fileset.FileSet
    uptodate: dv_flow.mgr.std.fileset.FileSetUpToDate
    passthrough: all
    consumes: none
    with:
      base:
        doc: |
          Specifies the base directory for the fileset.
        type: str
        value: ""
      type:
        doc: |
          Specifies the file type (eg verilogSource) for the fileset.
        type: str
        value: ""
      incdirs:
        type: list
      defines:
        type: list
      attributes:
        type: list
      include:
        doc: |
          Specifies a list of files or a glob pattern for the files to include
        type: list
        value: []
      exclude:
        type: list
        value: []
  - name: CreateFile
    shell: pytask
    run: dv_flow.mgr.std.create_file.CreateFile
    passthrough: all
    consumes: none
    doc: |
      Creates one or more files in the run directory from 
      literal content in the .dv file. Outputs a fileset 
      referencing all the created files.
    with:
      type:
        desc: Content-type to use for the fileset
        type: str
        value: ""
      filename:
        type: str
      content:
        type: str
      incdir: 
        type: bool
        value: false
  - name: SetEnv
    desc: Sets environment variables for use by other tasks
    shell: pytask
    run: dv_flow.mgr.std.setenv.SetEnv
    uptodate: dv_flow.mgr.std.setenv.SetEnvUpToDate
    with:
      setenv:
        type: map
      append_path:
        type: map
      prepend_path:
        type: map

  - name: SetFileType
    consumes:
    - type: std.FileSet 
    desc: Outputs all input filesets with the specified filetype
    shell: pytask
    run: dv_flow.mgr.std.set_file_type.SetFileType
    with:
      filetype:
        type: str
        value: ""
  - name: IncDirs
    shell: pytask
    run: dv_flow.mgr.std.incdirs.IncDirs
    doc: |
      Creates a list of include directories from a set of
      input files.

  - name: AgentToolStdio
    desc: |
      Configures an MCP (Model Context Protocol) server that uses stdio transport.
      This task validates the command, optionally installs dependencies, and outputs
      an AgentTool data item that can be consumed by Agent tasks to enable MCP tools.
      
      Common use cases:
      - @modelcontextprotocol/server-filesystem: File system access
      - @modelcontextprotocol/server-github: GitHub API integration
      - mcp-server-sqlite: SQLite database queries
    shell: pytask
    run: dv_flow.mgr.std.agent_tool_stdio.AgentToolStdio
    with:
      command:
        type: str
        value: ""
        doc: |
          Command to execute the MCP server (e.g., 'npx', 'node', 'python')
      args:
        type: list
        value: []
        doc: |
          Arguments to pass to the command. For npx servers, typically:
          ['-y', '@modelcontextprotocol/server-filesystem', '/allowed/path']
      install_command:
        type: str
        value: ""
        doc: |
          Optional command to install server dependencies (e.g., 'npm install -g server-name').
          Only runs once, tracked via memento.
      env:
        type: map
        value: {}
        doc: |
          Environment variables to set when running the server

  - name: AgentToolHttp
    desc: |
      Configures an MCP server that uses HTTP/SSE transport.
      This task validates the URL, optionally checks accessibility, and outputs
      an AgentTool data item for use by Agent tasks.
      
      Use for remote MCP services or local HTTP-based MCP servers.
    shell: pytask
    run: dv_flow.mgr.std.agent_tool_http.AgentToolHttp
    with:
      url:
        type: str
        value: ""
        doc: |
          Base URL of the MCP server (e.g., 'https://api.example.com/mcp' or 'http://localhost:8080')
      validate:
        type: bool
        value: false
        doc: |
          Whether to validate that the URL is accessible. Set to true for remote servers.
      health_check_path:
        type: str
        value: ""
        doc: |
          Optional path to append to URL for health check (e.g., '/health').
          If specified and validate=true, performs GET request to this endpoint.
      headers:
        type: map
        value: {}
        doc: |
          HTTP headers to include in requests (e.g., Authorization headers)
      timeout:
        type: int
        value: 5
        doc: |
          Timeout in seconds for validation requests

  - name: Agent
    desc: |
      Executes an AI assistant with a specified prompt and collects 
      structured results. The assistant MUST create a valid JSON result
      file or the task will fail.
      
      Supported assistants: GitHub Copilot (copilot), OpenAI Codex (codex)
      
      If no assistant is specified, auto-probes for available assistants
      in priority order: copilot, codex.
    shell: pytask
    run: dv_flow.mgr.std.agent.Agent
    with:
      system_prompt:
        type: str
        doc: |
          System prompt template. Can include variable references:
          - ${{ inputs }} - JSON of input data (runtime expansion)
          - ${{ name }} - Task name (runtime expansion)
          - ${{ result_file }} - Expected result filename (runtime expansion)
          Note: These use DV Flow's ${{ }} syntax but are expanded at runtime
          If empty, uses default template.
        value: ""
      user_prompt:
        type: str
        value: ""
        doc: |
          User's prompt content. Combined with system_prompt.
      result_file:
        type: str
        value: ""
        doc: |
          Name of JSON result file (default: {name}.result.json).
          Assistant MUST write valid JSON to this file or task fails.
      assistant:
        type: str
        value: ""
        doc: |
          Override default AI assistant. Options: copilot, codex, openai, claude
          If empty, auto-probes for available assistants (copilot > codex).
      model:
        type: str
        value: ""
        doc: |
          Specify the model to use (e.g., gpt-4, o4-mini, claude-3-opus). 
          If empty, uses the assistant's default model.
      sandbox_mode:
        type: str
        value: "off"
        doc: |
          Sandbox mode for Codex assistant. Options:
          - off: No sandboxing (default for workflow execution)
          - read-only: Read-only filesystem access
          - network-disabled: Filesystem access but no network
          - full: Full sandboxing (read-only + no network)
          Note: Only applies to codex assistant.
      approval_mode:
        type: str
        value: "full-auto"
        doc: |
          Approval mode for Codex assistant. Options:
          - suggest: Suggest changes, require approval
          - auto-edit: Auto-edit files, require approval for other actions
          - full-auto: Fully autonomous (default for workflow execution)
          Note: Only applies to codex assistant.
      max_retries:
        type: int
        value: 10
        doc: |
          Maximum number of retry attempts if assistant fails or produces
          empty output. Default: 10
      assistant_config:
        type: map
        doc: |
          Additional assistant-specific configuration.
          For codex: sandbox_mode and approval_mode can also be set here.

  types:
  - name: Tag
    doc: |
      Base type for all tags. Tags are used to categorize and filter tasks and packages.
    with:
      category:
        type: str
        value: ""
      value:
        type: str
        value: ""

  - name: AgentSkillTag
    uses: std.Tag
    doc: |
      Tag that marks datasets as useful agent skills. Agent skills are 
      capabilities that can be discovered and utilized by AI agents to 
      perform specialized tasks.

  - name: AgentToolTag
    uses: std.Tag
    doc: |
      Tag that marks datasets as containing tool definitions

  - name: AgentPersonaTag
    uses: std.Tag
    doc: |
      Tag that marks datasets as containing a persona

  - name: AgentReferenceTag
    uses: std.Tag
    doc: |
      Tag that marks datasets as containing references

  - name: DataItem
    with:
      type:
        type: str
      desc:
        type: str
        value: ""
        doc: |
          Optional description for this data item

  - name: FileSet
    uses: std.DataItem
    with:
      filetype:
        type: str
        value: ""
      basedir:
        type: str
      files:
        type:
          list:
            item: str
      incdirs:
        type:
          list:
            item: str
      defines:
        type:
          list:
            item: str
      attributes:
        type:
          list:
            item: str

  - name: Env
    doc: |
      Environment variables
    with:
      vals:
        type:
          map:
            key:
              type: str
            val:
              type: str
      append_path:
        doc: |
          Path elements to append to existing environment variables
        type:
          map:
            key:
              type: str
            val:
              type: str
      prepend_path:
        doc: |
          Path elements to prepend to existing environment variables
        type:
          map:
            key:
              type: str
            val:
              type: str

  - name: AgentResource
    uses: std.DataItem
    doc: |
      Base dataset type for agent skills, tools, references, and personas.
      Provides common fields for specifying content via files, inline content, or URLs.
    with:
      files:
        type: list
        doc: |
          List of files to include in this resource
      content:
        type: str
        doc: |
          Inline content for this resource
      urls:
        type: list
        doc: |
          URLs pointing to external resources

  - name: AgentSkill
    uses: std.AgentResource
    doc: |
      Defines an agent skill dataset. Agent skills represent capabilities 
      that AI agents can discover and utilize to perform specialized tasks.
      
      Packages should define an AgentSkill type that uses std.AgentSkill
      to expose their capabilities to LLM agents. The skill documentation
      should be provided in a skill.md file.
    tags: [std.AgentSkillTag]

  - name: AgentPersona
    uses: std.DataItem
    doc: |
      Specifies a persona
    tags: [std.AgentPersonaTag]
    with:
      persona:
        type: str

  - name: AgentTool
    uses: std.DataItem
    doc: |
      Specifies a URL or set of files that specify an MCP server to use
    tags: [std.AgentToolTag]
    with:
      command:
        type: str
      args:
        type: list
      url: 
        type: str

  - name: AgentReference
    uses: std.AgentResource
    doc: |
      Specifies a set of files or URLs for an agent to use as reference
    tags: [std.AgentReferenceTag]
